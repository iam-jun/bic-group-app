default_platform(:android)
fastlane_require 'dotenv'

platform :android do
  lane :deploy_dev do
    Dotenv.overload('../../.env.sample', '../../.env')

    appVersionText = ENV['APP_VERSION'].length > 0 ? "(the app version is: " + ENV['APP_VERSION'] + ")" : ""
    commit = last_git_commit
    git_mess = changelog_from_git_commits(commits_count: 1, pretty: "- (%ae) %s")

    gradle(task: "clean")
    gradle(
      task: "assemble",
      build_type: "Release",
      flavor: "Development",
      #properties: {
      #  "versionCode" => buildNumber.strip,
      #}
    )

    diawi(
      token: ENV['DIAWI_TOKEN'],
      file: lane_context[SharedValues::GRADLE_ALL_APK_OUTPUT_PATHS][0],
      timeout: 600,
    )
    mattermost(
        url: "https://team.bein.group/hooks/ufdi5exyo3f8bjt3m8cub986wr",
        text: "@all\nðŸŸ£ðŸ¤– **Bein Dev Android** New build #{appVersionText} at: #{lane_context[SharedValues::UPLOADED_FILE_LINK_TO_DIAWI]}
            \n > **Git Branch**: #{git_branch}
            \n **Git Author**: #{commit[:author]}
            \n **Git Commit**: #{git_mess}",
        username: "bein.bot",
        icon_url: "https://cdn1.iconfinder.com/data/icons/youtuber/256/bell-notifications-notice-notify-alert-512.png",
    )
  end

  lane :deploy_staging do
    Dotenv.overload('../../.env.sample', '../../.env.staging')

    appVersionText = ENV['APP_VERSION'].length > 0 ? "(the app version is: " + ENV['APP_VERSION'] + ")" : ""
    commit = last_git_commit
    git_mess = changelog_from_git_commits(commits_count: 1, pretty: "- (%ae) %s")

    gradle(task: "clean")
    gradle(
      task: "assemble",
      build_type: "Release",
      flavor: "Staging",
    )
    diawi(
      token: ENV['DIAWI_TOKEN'],
      file: lane_context[SharedValues::GRADLE_ALL_APK_OUTPUT_PATHS][0],
      timeout: 600,
    )
    mattermost(
        url: "https://team.bein.group/hooks/ufdi5exyo3f8bjt3m8cub986wr",
        text: "@all\nðŸŸ¡ðŸ¤– **Bein Staging Android** New build #{appVersionText} at: #{lane_context[SharedValues::UPLOADED_FILE_LINK_TO_DIAWI]}
            \n > **Git Branch**: #{git_branch}
            \n **Git Author**: #{commit[:author]}
            \n **Git Commit**: #{git_mess}",
        username: "bein.bot",
        icon_url: "https://cdn1.iconfinder.com/data/icons/youtuber/256/bell-notifications-notice-notify-alert-512.png",
    )
#     upload_to_play_store_internal_app_sharing
  end

    lane :deploy_production do
        Dotenv.overload('../../.env.sample', '../../.env.production')
        appVersionText = ENV['APP_VERSION'].length > 0 ? "(the app version is: " + ENV['APP_VERSION'] + ")" : ""
        commit = last_git_commit
        git_mess = changelog_from_git_commits(commits_count: 1, pretty: "- (%ae) %s")
        gradle(task: "clean")
        gradle(
          task: "assemble",
          build_type: "Release",
          flavor: "Production",
        )
        diawi(
          token: ENV['DIAWI_TOKEN'],
          file: lane_context[SharedValues::GRADLE_ALL_APK_OUTPUT_PATHS][0],
          timeout: 600,
        )
        mattermost(
            url: "https://team.bein.group/hooks/ufdi5exyo3f8bjt3m8cub986wr",
            text: "@all\nðŸŸ¢ðŸ¤– **Bein Production Android** New build #{appVersionText} at: #{lane_context[SharedValues::UPLOADED_FILE_LINK_TO_DIAWI]}
                \n > **Git Branch**: #{git_branch}
                \n **Git Author**: #{commit[:author]}
                \n **Git Commit**: #{git_mess}",
            username: "bein.bot",
            icon_url: "https://cdn1.iconfinder.com/data/icons/youtuber/256/bell-notifications-notice-notify-alert-512.png",
        )
    end
end
