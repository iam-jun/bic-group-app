default_platform(:ios)
fastlane_require "dotenv"

# Avoid build iOS fail after iTMSTransporter auto updated to 3.0
before_all do
  ENV['ITMSTRANSPORTER_FORCE_ITMS_PACKAGE_UPLOAD'] = 'true'
end

platform :ios do
  before_all do
    setup_circle_ci
  end

  lane :sync_profile do
    match(type: "development", readonly: false, force: true)
    match(type: "appstore", readonly: false, force: true)
  end

  lane :deploy_staging do
    Dotenv.overload('../../.env.sample', '../../.env.staging')

    match(
      type: "appstore",
      app_identifier: "#{ENV['BUNDLE_IDENTIFIER']}.staging",
      storage_mode: "git",
      team_id: "44S5N8GAPS",
      team_name: "UFUTURE CORPORATION",
      readonly: false,
      force: true,
      verbose: true,
    )

    appVersionText = ENV['APP_VERSION'].length > 0 ? "**" + ENV['APP_VERSION'] + "**" : ""

    commit = last_git_commit
    git_mess = changelog_from_git_commits(commits_count: 1, pretty: "- (%ae) %s")

    increment_build_number(
      build_number: latest_testflight_build_number(app_identifier: "#{ENV['BUNDLE_IDENTIFIER']}.staging") + 1,
      xcodeproj: "./#{ENV['SCHEME_NAME']}.xcodeproj"
    )

    build_app(
      workspace: "#{ENV['SCHEME_NAME']}.xcworkspace",
      scheme: "#{ENV['SCHEME_NAME_IOS']}",
      configuration: "ReleaseStaging",
      output_directory:"./fastlane/staging/",
      output_name: "#{ENV['SCHEME_NAME_IOS']}.ipa",
      export_method: "app-store",
      silent: true,
      clean: true,
    )

    upload_to_testflight(
      app_identifier: "#{ENV['BUNDLE_IDENTIFIER']}.staging",
      ipa: "./fastlane/staging/#{ENV['SCHEME_NAME_IOS']}.ipa",
      changelog: "Staging version #{ENV['APP_VERSION']}",
      api_key_path: "ios/fastlane/api_key_info.json",
    )

    notice_to_bic("üü°üçé Alo alo c√≥ build #{appVersionText} @ngoclinh @trankimmai @ngoccuong @triduc
      \n **BIC Group Staging iOS**
      \n T·∫£i t·∫°i: TestFlight.
      \n **Git Branch**: #{git_branch}
      \n **Git Commit**: #{git_mess}",
      ['8b311540-9bb3-4b60-abfe-83b9ce20959c','cbb27290-f61c-46e2-a0ce-0c67d02c7411','5b2939a5-302c-4332-af78-663083e97c6d','ce9616ad-3fe5-4180-b657-480661e09541'],
      '65864708-d4e6-4360-aa89-32fef3cd1b9a')
  end

  lane :deploy_production do
    Dotenv.overload('../../.env.sample', '../../.env.production')

    match(
      type: "appstore",
      app_identifier: "#{ENV['BUNDLE_IDENTIFIER']}",
      storage_mode: "git",
      team_id: "44S5N8GAPS",
      team_name: "UFUTURE CORPORATION",
      readonly: false,
      force: true,
      verbose: true,
    )

    appVersionText = ENV['APP_VERSION'].length > 0 ? "**" + ENV['APP_VERSION'] + "**" : ""

    commit = last_git_commit
    git_mess = changelog_from_git_commits(commits_count: 1, pretty: "- (%ae) %s")

    increment_build_number(
      build_number: latest_testflight_build_number(app_identifier: "#{ENV['BUNDLE_IDENTIFIER']}") + 1,
      xcodeproj: "./#{ENV['SCHEME_NAME']}.xcodeproj"
    )

    build_app(
      workspace: "#{ENV['SCHEME_NAME']}.xcworkspace",
      scheme: "#{ENV['SCHEME_NAME_IOS']}",
      configuration: "Release",
      output_directory:"./fastlane/production/",
      output_name: "#{ENV['SCHEME_NAME_IOS']}.ipa",
      export_method: "app-store",
      silent: true,
      clean: true,
    )

    upload_to_testflight(
      app_identifier: "#{ENV['BUNDLE_IDENTIFIER']}",
      ipa: "./fastlane/production/#{ENV['SCHEME_NAME_IOS']}.ipa",
      changelog: "Production version #{ENV['APP_VERSION']}",
      api_key_path: "ios/fastlane/api_key_info.json",
    )

    notice_to_bic("üü¢üçé Alo alo c√≥ build #{appVersionText} @ngoclinh @trankimmai @ngoccuong @triduc
      \n **BIC Group iOS**
      \n T·∫£i t·∫°i: TestFlight.
      \n **Git Branch**: #{git_branch}
      \n **Git Commit**: #{git_mess}",
      ['8b311540-9bb3-4b60-abfe-83b9ce20959c','cbb27290-f61c-46e2-a0ce-0c67d02c7411','5b2939a5-302c-4332-af78-663083e97c6d','ce9616ad-3fe5-4180-b657-480661e09541'],
      '65864708-d4e6-4360-aa89-32fef3cd1b9a')
  end

  lane :deploy_staging_ci do
      app_store_connect_api_key(
          key_id: "XJ428WDDS9",
          issuer_id: "69a6de93-bcc0-47e3-e053-5b8c7c11a4d1",
          key_content: "-----BEGIN PRIVATE KEY-----\nMIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgZvH4Nl3l7LtF4BDP\nnSL4HNR1uD8M3pJKGIFR0maeCTCgCgYIKoZIzj0DAQehRANCAAQG2c/tJ3g2QAGy\nkFsV5sPhF/ILH6BttjT0/EDU5e23qrJaQME6ZnE7mnm+awoSynvZYfZ9uPb6yijw\nmN0V3uDM\n-----END PRIVATE KEY-----"
        )

      deploy_staging
    end

    lane :deploy_production_ci do
      app_store_connect_api_key(
          key_id: "XJ428WDDS9",
          issuer_id: "69a6de93-bcc0-47e3-e053-5b8c7c11a4d1",
          key_content: "-----BEGIN PRIVATE KEY-----\nMIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgZvH4Nl3l7LtF4BDP\nnSL4HNR1uD8M3pJKGIFR0maeCTCgCgYIKoZIzj0DAQehRANCAAQG2c/tJ3g2QAGy\nkFsV5sPhF/ILH6BttjT0/EDU5e23qrJaQME6ZnE7mnm+awoSynvZYfZ9uPb6yijw\nmN0V3uDM\n-----END PRIVATE KEY-----"
        )

      deploy_production
    end
  end
